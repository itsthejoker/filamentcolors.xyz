{% extends base_template %}
{% load static %}

{% block content %}
  <div class="container mt-4">
    {% include 'partials/messages.partial' %}
    <h1>Filament Donations</h1>

    {% include 'components/alerts/non-us-shipping-warning.partial' %}

    <p>
      This site is mostly powered by filament donations, either from manufacturers
      directly or fellow hobbyists. This isn't my job (though I do have a lot of
      fun with it), so I can't afford to bring you all the filaments on the face of
      the earth... but you can help with that!
    </p>
    <p>
      If you have a filament that I don't, I want to make it easy for you to get
      that filament to me so that we can get it in the library. Here's the important
      part before we get to the details:
    </p>
    <div class="container mt-3">
      <div class="alert alert-primary" role="alert">
        If you need help with shipping, I have a budget of $100 a month to pay
        shipping costs for anyone that needs or wants reimbursement—all I need
        is a receipt from your shipping provider of choice.
      </div>
    </div>
    <p>
      There are a lot of plastics that I have on hand but might not be on the site
      yet—take a look at the inventory to make sure what you have is new to the
      library! If you have any questions, give me a shout!
    </p>
    <h2>Check The Inventory</h2>
    <div class="donation-search-wrapper mt-3 mb-3 container">
      <p class="text-muted mb-3">
        Start typing the filament name, manufacturer, or color family to see if I already have it. If there are no
        results, you've got something I don't have, and I'd love to add it to the library! Search results here
        include both published and not-yet-published swatches.
      </p>
      <div class="donation-search input-group input-group-lg">
        <span class="input-group-text"><span class="icon-search"></span></span>
        <input
          type="text"
          id="donationSearchInput"
          class="form-control"
          placeholder="e.g., Hatchbox, Sakura Pink, PLA, Blue"
          aria-label="Search swatches"
          role="combobox"
          aria-expanded="false"
          aria-controls="donationSearchOverlay"
          hx-trigger="keyup changed delay:0.4s, fireSearch from:body"
          hx-get="{% url 'inventory_search' %}"
          name="f"
          hx-target="#donationSearchResults"
          hx-swap="innerHTML"
          hx-indicator="#donationSearchIndicator"
          hx-push-url="false"
        />
      </div>

      <div id="donationSearchOverlay" class="donation-overlay" role="listbox" aria-labelledby="donationSearchInput">
        <div id="donationSearchIndicator" class="htmx-indicator p-3">
          <div class="placeholder-glow">
            <span class="placeholder col-3"></span>
            <span class="placeholder col-4"></span>
            <span class="placeholder col-2"></span>
          </div>
        </div>
        <div id="donationSearchResults" class="list-group">
          <div class="text-center text-muted py-3">Start typing to search…</div>
        </div>
      </div>
    </div>

    <h2>Supplies Needed</h2>
    <ul>
      <li>
        Sandwich Baggies (I use something like
        <a href="https://amzn.to/37xaDB6" target="_blank">this</a>
        but you can get them cheaper at your local dollar store)
      </li>
      <li>
        Pen / pencil
      </li>
      <li>
        Knife or scissors
      </li>
      <li>
        A padded envelope to ship in (more info on that later)
      </li>
      <li>
        A way to print out (or make) the labels for your filaments
      </li>
    </ul>
    <p>
      You can use something else to hold the filament if you'd like; the important
      part is that the labels you print out in the next part stay with the proper
      coils. Little baggies are tried and tested, so that's what I recommend.
    </p>
    <h2>
      Process
    </h2>
    <h3>Gather your filaments</h3>
    <p>
      I can print most filaments that are printable on a consumer-grade printer with
      a hardened nozzle. Things that I <strong>cannot take at this time include:</strong>
    </p>
    <ul>
      <li>
        <strong>3mm filament</strong>
      </li>
      <li>
        <strong>Tri-(or more)-color filament</strong>
      </li>
      <li>
        <strong>Rainbow / transition filament</strong>
      </li>
      <li>
        <strong>Super high-temp exotics</strong>
      </li>
    </ul>
    <p>
      Everything else is fair game, including engineering samples and coextrusions.
      If you have 3mm filament that you want to donate and a 3mm printer, please
      <a href="mailto:joe@filamentcolors.xyz?subject=3mm%20Filament">
        get in touch with me so that we can work something out.
      </a>
    </p>
    <h4>Print (or make!) labels</h4>
    <p>
      For each filament that you want to donate, you'll need a label. I've made a
      <a href="https://docs.google.com/document/d/1IOmYzft4akuNpfyuu-GmaP0aUmXXBQMo6uXBWCKYRtk/edit?usp=sharing"
         target="_blank">
        Google Doc</a> that you can use to print out labels. If you don't have a printer,
      you can write the information on a piece of paper and cut it out to put in the bag.
    </p>
    <div class="text-center">
      <a
        href="https://docs.google.com/document/d/1IOmYzft4akuNpfyuu-GmaP0aUmXXBQMo6uXBWCKYRtk/edit?usp=sharing"
        target="_blank"
        class="btn btn-primary bg-gradient btn-lg"
      >
        Print Labels
      </a>
    </div>
    <p>
      Each label needs the following information:
    </p>
    <ul>
      <li>
        <strong>Filament Type</strong> — PLA? PLA+? ABS? PETG? TPU? Nylon? etc.
      </li>
      <li>
        <strong>Filament Name</strong> — What is the technical name of the filament?
        (e.g. <strong>Sakura Pink</strong>)
      </li>
      <li>
        <strong>Manufacturer</strong> — Who makes the filament? (e.g.
        <strong>Hatchbox</strong>, <strong>Prusament</strong>, etc.)
      </li>
      <li>
        <strong>Your name</strong> — If you would like to be credited on the site,
        include how you want to be credited here.
      </li>
    </ul>

    <p>
      An example label might read:
    </p>
    <div class="container">
      <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-4 mx-auto">
          <div class="alert alert-primary">
            <strong>Filament Type:</strong> Matte PLA<br>
            <strong>Filament Name:</strong> Sakura Pink<br>
            <strong>Manufacturer:</strong> Elegoo<br>
            <strong>Your name:</strong> Joe K.
          </div>
        </div>
      </div>
    </div>
    <p>
      Make sure that this label is as accurate to the filament as possible — the more
      information, the better! If the label is not in English, please write the names
      as you see them on the label. (For example, if you have a German filament sold as
      "Himbeerrot", you should write that instead of translating it to "Raspberry Red".)
    </p>
    <h4>Prepare each filament</h4>
    <p>
      For each filament, cut a small piece that is at least 2 meters long. (If you don't
      have a good way to measure it: hold the spool in one hand, the end of the filament
      in the other, and open your arms as wide as you can. Do that twice and it should be
      enough.) Coil it up and put it in a baggie with its proper label. If you want to
      save some space, you can combine multiple filaments in one baggie as long as they
      are very easy to tell apart (e.g., a white and a black filament), but I recommend
      using one bag per filament if you can as it makes it easier on my side.
    </p>
    <p>
      Side note: please do not put in 26 filaments into a single bag with all
      the labels in a pile. I've had to untangle that mess before and it's not fun.
    </p>


    <h3>Prepare to ship</h3>
    <p>
      Most flat-rate packaging (or whatever is designed for small, mostly flat things)
      will work for shipping filament. If you're in the US, the USPS has Priority Mail
      Flat-Rate padded envelopes that work well. Stick your filament bags in there and
      address it as follows:
    </p>
    <div class="row">
      <div class="col-sm-12 col-md-4 mx-auto">
        <div class="alert alert-primary text-center">
          Joe Kaufeld<br>
          FilamentColors.xyz<br>
          1701 E. Edgewood Ave #17247<br>
          Indianapolis, IN 46217
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12 col-md-6 col-lg-5 mx-auto">
        <div class="alert alert-danger" role="alert">
          <strong>Note!</strong> Make sure that you include the unit number
          <strong>(#17247)</strong> in the address. If you omit it, the package will be
          returned to you and I will never know it was there.
        </div>
      </div>
    </div>

    <p>
      I can receive packages from any carrier and country, so feel free to use whatever
      is most convenient for you. UPS, FedEx, DHL, etc. are all fine. If you have any
      questions about donating, feel free to
      <a href="mailto:joe@filamentcolors.xyz?subject=Filament%20Donation">shoot me an email</a>
      so that we can chat!
    </p>
    <h3>Ship that sucker!</h3>
    <p>
      Drop your package in the mail, and I'll get your filaments indexed as soon as I can.
      Because this is a hobby, the current queue is roughly a few months... but they
      will get added! Feel free to follow up and make sure that I've received them.
    </p>
    <h2 id="print-them-yourself">Want to print them yourself?</h2>
    <p>
      If you're really itching to print them yourself, follow the below instructions.
      Please note that if you print swatches and send them without verifying quality
      first, I may not be able to accept them.
    </p>
    <p>
      Open the below file in the slicer of your choice and configure the following
      settings:
    </p>
    <ul>
      <li>3 walls</li>
      <li>3 top layers</li>
      <li>3 bottom layers</li>
      <li>17% hexagonal (sometimes called 'honeycomb') infill</li>
      <li>0.2mm layers (should be 10 layers high when sliced)</li>
    </ul>
    <p>
      <strong>Print one and send me pictures of the top, bottom, and side of the print</strong>
      so that I can doublecheck quality. If it looks good, then you'll be good to go
      with printing the rest as long as they match or exceed the quality of the first
      one. I also need a cutting of the filament you used to print the swatches so that
      I can measure it for its TD value; just <strong>10 cm / 4 in</strong> is all
      that's needed. Please make sure it's with the swatch when you send it in!
    </p>
    <p>
      Please note that I will not be able to return any swatches sent in, so please
      don't send me anything you're not willing to part with.
    </p>
    <div class="text-center">
      <a
        href="{% static 'swatch.stl' %}"
        class="btn btn-primary"
        hx-boost="false"
        download
      >Download Swatch</a>
    </div>
    <h2>Final Thoughts</h2>
    <p>
      Thank you so much for considering donating to the library. The more colors we
      add, the more useful this site is to everyone. Most of the colors I have are
      only easily available in the U.S., so I <em>definitely</em> want to hear from you
      if you live elsewhere!
    </p>
    <p>
      Cheers and happy printing!
    </p>
  </div>
  <script>
    (function () {
      const input = document.getElementById('donationSearchInput')
      const overlay = document.getElementById('donationSearchOverlay')
      const indicator = document.getElementById('donationSearchIndicator')
      const results = document.getElementById('donationSearchResults')
      if (!input || !overlay) return

      const open = () => {
        overlay.classList.add('is-open');
        input.setAttribute('aria-expanded', 'true')
      }
      const close = () => {
        overlay.classList.remove('is-open');
        input.setAttribute('aria-expanded', 'false')
      }
      const hasText = () => input.value.trim().length > 0

      const clamp = (n, min, max) => Math.max(min, Math.min(max, n))
      const updateIndicatorPlaceholders = (count) => {
        if (!indicator) return
        const n = clamp(count || 0, 1, 5)  // safety limiter
        let html = ''
        for (let i = 0; i < n; i++) {
          html += `
            <div class="placeholder-glow mt-2">
              <span class="placeholder col-${Math.round((Math.random()/2*10)+1).toString()}"></span>
              <span class="placeholder col-${Math.round((Math.random()/2*10)+1).toString()} ms-2"></span>
              <span class="placeholder col-${Math.round((Math.random()/2*10)+1).toString()} ms-2"></span>
            </div>
          `
        }
        indicator.innerHTML = html
      }

      // Observe the HTMX indicator visibility and wipe results when it shows
      if (indicator && results) {
        const isIndicatorVisible = () => (
          indicator.classList.contains('htmx-request') ||
          window.getComputedStyle(indicator).display !== 'none'
        )
        let wasVisible = isIndicatorVisible()
        const wipeResults = () => {
          // Clear existing results so placeholders are the only visible content
          results.innerHTML = ''
        }
        const mo = new MutationObserver(() => {
          const nowVisible = isIndicatorVisible()
          if (nowVisible && !wasVisible) {
            wipeResults()
          }
          wasVisible = nowVisible
        })
        mo.observe(indicator, { attributes: true, attributeFilter: ['class', 'style', 'hidden', 'aria-hidden'] })
      }

      input.addEventListener('focus', () => {
        if (hasText()) open()
      })
      input.addEventListener('input', () => {
        hasText() ? open() : close()
      })

      document.addEventListener('click', (e) => {
        if (e.target === input || overlay.contains(e.target)) return
        close()
      })
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close()
      })

      // HTMX lifecycle: open when results arrive, close if server echoes empty input
      document.body.addEventListener('htmx:afterSwap', (evt) => {
        const tgt = evt.detail && evt.detail.target
        if (tgt && tgt.id === 'donationSearchResults') {
          // Update the indicator to have the same number of placeholder rows as the
          // number of result items that were just rendered (up to five). This sets
          // up the next request to display a matching skeleton while loading.
          const items = tgt.querySelectorAll('[role="option"]').length
          updateIndicatorPlaceholders(items)

          if (hasText()) open(); else close()
        }
      })
    })()
  </script>
{% endblock content %}
